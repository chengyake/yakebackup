
#include <math.h>
#include "mel_filter.h"


//三角滤波器中心频率点
const unsigned short tri_freq[]=
{
    0,11,22,33,44,55,66,77,88,99,110,121,134,152,171,191,214,237,263,291,321,354,389,427,468,512
};

//奇数三角滤波器首尾相连的折线
const unsigned short tri_odd[]=
{
    0,0,0,0,0,0,0,0,0,0,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,77,154,231,308,385,462,538,615,692,769,846,923,1000,944,889,833,778,722,667,611,556,500,444,389,333,278,222,167,111,56,0,53,105,158,211,263,316,368,421,474,526,579,632,684,737,789,842,895,947,1000,950,900,850,800,750,700,650,600,550,500,450,400,350,300,250,200,150,100,50,0,43,87,130,174,217,261,304,348,391,435,478,522,565,609,652,696,739,783,826,870,913,957,1000,957,913,870,826,783,739,696,652,609,565,522,478,435,391,348,304,261,217,174,130,87,43,0,38,77,115,154,192,231,269,308,346,385,423,462,500,538,577,615,654,692,731,769,808,846,885,923,962,1000,964,929,893,857,821,786,750,714,679,643,607,571,536,500,464,429,393,357,321,286,250,214,179,143,107,71,36,0,33,67,100,133,167,200,233,267,300,333,367,400,433,467,500,533,567,600,633,667,700,733,767,800,833,867,900,933,967,1000,970,939,909,879,848,818,788,758,727,697,667,636,606,576,545,515,485,455,424,394,364,333,303,273,242,212,182,152,121,91,61,30,0,29,57,86,114,143,171,200,229,257,286,314,343,371,400,429,457,486,514,543,571,600,629,657,686,714,743,771,800,829,857,886,914,943,971,1000,974,947,921,895,868,842,816,789,763,737,711,684,658,632,605,579,553,526,500,474,447,421,395,368,342,316,289,263,237,211,184,158,132,105,79,53,26,0,24,49,73,98,122,146,171,195,220,244,268,293,317,341,366,390,415,439,463,488,512,537,561,585,610,634,659,683,707,732,756,780,805,829,854,878,902,927,951,976,1000,977,955,932,909,886,864,841,818,795,773,750,727,705,682,659,636,614,591,568,545,523,500,477,455,432,409,386,364,341,318,295,273,250,227,205,182,159,136,114,91,68,45,23,0
};

//偶数三角滤波器首尾相连的折线
const unsigned short tri_even[]=
{
    91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,909,818,727,636,545,455,364,273,182,91,0,91,182,273,364,455,545,636,727,818,909,1000,923,846,769,692,615,538,462,385,308,231,154,77,0,56,111,167,222,278,333,389,444,500,556,611,667,722,778,833,889,944,1000,947,895,842,789,737,684,632,579,526,474,421,368,316,263,211,158,105,53,0,50,100,150,200,250,300,350,400,450,500,550,600,650,700,750,800,850,900,950,1000,957,913,870,826,783,739,696,652,609,565,522,478,435,391,348,304,261,217,174,130,87,43,0,43,87,130,174,217,261,304,348,391,435,478,522,565,609,652,696,739,783,826,870,913,957,1000,962,923,885,846,808,769,731,692,654,615,577,538,500,462,423,385,346,308,269,231,192,154,115,77,38,0,36,71,107,143,179,214,250,286,321,357,393,429,464,500,536,571,607,643,679,714,750,786,821,857,893,929,964,1000,967,933,900,867,833,800,767,733,700,667,633,600,567,533,500,467,433,400,367,333,300,267,233,200,167,133,100,67,33,0,30,61,91,121,152,182,212,242,273,303,333,364,394,424,455,485,515,545,576,606,636,667,697,727,758,788,818,848,879,909,939,970,1000,971,943,914,886,857,829,800,771,743,714,686,657,629,600,571,543,514,486,457,429,400,371,343,314,286,257,229,200,171,143,114,86,57,29,0,26,53,79,105,132,158,184,211,237,263,289,316,342,368,395,421,447,474,500,526,553,579,605,632,658,684,711,737,763,789,816,842,868,895,921,947,974,1000,976,951,927,902,878,854,829,805,780,756,732,707,683,659,634,610,585,561,537,512,488,463,439,415,390,366,341,317,293,268,244,220,195,171,146,122,98,73,49,24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};





void mel_filter(unsigned int *data, unsigned int *out) {

    int i, j;

    for(i=0; i<24; i++) {
        out[i] = 0;
        //even
        if(i%2 == 0) {
            for(j=tri_freq[i]; j<tri_freq[i+2]; j++) {
                out[i] += (data[j]*tri_even[j]/(100));
            }
        }
        //odd
        if(i%2 != 0) {
            for(j=tri_freq[i]; j<tri_freq[i+2]; j++) {
                out[i] += (data[j]*tri_odd[j]/(100));
            }
        }
        //log 

        out[i]=(unsigned int)(log(out[i])*100);//取对数后 乘100 提升数据有效位数
    }
}
